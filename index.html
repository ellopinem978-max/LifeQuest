<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LifeQuest - Gamify Your Life (Online AI)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Custom Styles -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600;900&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #020617; /* slate-950 */
            color: #e2e8f0; /* slate-200 */
            -webkit-tap-highlight-color: transparent;
        }

        .font-mono { font-family: 'JetBrains Mono', monospace; }
        .glow-text { text-shadow: 0 0 15px rgba(16, 185, 129, 0.5); }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
        
        @keyframes bounce-dot {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-4px); }
        }
        .animate-bounce-dot { animation: bounce-dot 0.6s infinite; }
        
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }

        /* Utility for radar chart positioning */
        .radar-label {
            position: absolute;
            font-size: 11px;
            font-weight: 800;
            transform: translate(-50%, -50%);
            text-shadow: 0 1px 2px rgba(0,0,0,0.8);
        }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden selection:bg-emerald-500/30">

    <!-- HEADER -->
    <header class="sticky top-0 z-50 bg-slate-950/90 backdrop-blur-md border-b border-slate-800 px-4 py-4 flex justify-between items-center shrink-0 shadow-lg">
        <div class="flex items-center gap-2">
            <i data-lucide="terminal" class="text-emerald-500 w-6 h-6"></i>
            <h1 class="font-black text-lg tracking-tighter text-white">LIFE<span class="text-emerald-500">QUEST</span></h1>
        </div>
        <div class="flex items-center gap-2">
            <div class="flex items-center gap-1.5 px-2 py-1 rounded-full bg-emerald-500/10 border border-emerald-500/20 shadow-[0_0_10px_rgba(16,185,129,0.2)]">
                <span class="relative flex h-2 w-2">
                  <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span>
                  <span class="relative inline-flex rounded-full h-2 w-2 bg-emerald-500"></span>
                </span>
                <span class="text-[10px] font-mono font-bold text-emerald-400">ONLINE</span>
            </div>
        </div>
    </header>

    <!-- MAIN CONTENT -->
    <main id="app-container" class="flex-1 overflow-y-auto overflow-x-hidden p-4 pb-32 max-w-md mx-auto w-full relative">
        <div id="loading-screen" class="flex flex-col items-center justify-center h-full space-y-4 px-6 text-center">
            <div class="relative">
                <div class="absolute inset-0 bg-emerald-500/20 blur-xl rounded-full"></div>
                <i data-lucide="loader-2" class="relative w-12 h-12 text-emerald-500 animate-spin"></i>
            </div>
            <p class="font-mono text-emerald-500 animate-pulse tracking-widest text-sm font-bold">CONNECTING TO DATABASE...</p>
            <p class="text-xs text-slate-500 max-w-xs">Memeriksa autentikasi Firebase...</p>
        </div>
    </main>

    <!-- BOTTOM NAVIGATION -->
    <nav class="fixed bottom-0 left-0 right-0 bg-slate-950/95 backdrop-blur-lg border-t border-slate-800 pb-safe z-50 shadow-[0_-5px_20px_rgba(0,0,0,0.5)]">
        <div class="max-w-md mx-auto flex justify-around p-3">
            <button onclick="router('dashboard')" id="nav-dashboard" class="flex flex-col items-center gap-1 p-2 rounded-xl transition-all text-slate-500 hover:text-slate-300 w-16">
                <i data-lucide="user" class="w-6 h-6"></i>
                <span class="text-[10px] font-bold">Status</span>
            </button>
            
            <button onclick="router('chat')" id="nav-chat" class="flex flex-col items-center gap-1 p-2 rounded-xl transition-all relative text-slate-500 hover:text-slate-300 w-16">
                <i data-lucide="message-square" class="w-6 h-6"></i>
                <span class="text-[10px] font-bold">Oracle</span>
                <span id="chat-notification" class="hidden absolute top-2 right-2 w-2.5 h-2.5 bg-emerald-500 rounded-full animate-ping"></span>
                <span id="chat-notification-dot" class="hidden absolute top-2 right-2 w-2.5 h-2.5 bg-emerald-500 rounded-full border-2 border-slate-950"></span>
            </button>

            <button onclick="router('quests')" id="nav-quests" class="flex flex-col items-center gap-1 p-2 rounded-xl transition-all relative text-slate-500 hover:text-slate-300 w-16">
                <i data-lucide="target" class="w-6 h-6"></i>
                <span class="text-[10px] font-bold">Quest</span>
                <span id="quest-badge" class="hidden absolute top-1 right-2 flex h-5 w-5 items-center justify-center rounded-full bg-emerald-600 text-[10px] text-white font-bold border-2 border-slate-950">0</span>
            </button>
        </div>
    </nav>

    <!-- JAVASCRIPT LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc, arrayUnion, arrayRemove, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- ERROR HANDLING ---
        function showFatalError(title, message, tips = []) {
            const el = document.getElementById('loading-screen');
            if(!el) return;
            const tipsHtml = tips.map(t => `<li class="break-words mb-1">${t}</li>`).join('');
            el.innerHTML = `
                <div class="bg-slate-900 border border-red-500/50 rounded-2xl p-6 max-w-sm mx-auto shadow-2xl shadow-red-900/20">
                    <div class="flex justify-center mb-4">
                        <div class="bg-red-500/10 p-3 rounded-full">
                            <i data-lucide="alert-triangle" class="w-10 h-10 text-red-500"></i>
                        </div>
                    </div>
                    <h2 class="text-xl font-bold text-white mb-2">${title}</h2>
                    <div class="bg-black/30 p-3 rounded border border-red-900/30 mb-4 max-h-32 overflow-y-auto">
                        <p class="text-xs font-mono text-red-300 break-words">${message}</p>
                    </div>
                    ${tips.length > 0 ? `
                    <div class="text-left">
                        <p class="text-xs font-bold text-slate-400 mb-2 uppercase tracking-wider">Solusi:</p>
                        <ul class="text-xs text-slate-400 list-disc pl-4 space-y-1">
                            ${tipsHtml}
                        </ul>
                    </div>` : ''}
                </div>
            `;
            lucide.createIcons();
        }

        // --- GEMINI API SETUP ---
        // INI KUNCI AI BARU ANDA (Untuk Chatbot)
        const GEMINI_API_KEY = "AIzaSyCccP54cN3wc80S44-DQDZgT-Ltsp1xKzM"; 

        async function callGeminiAI(userMessage, conversationHistory = []) {
            let activeKey = GEMINI_API_KEY;
            
            // Fallback Logic
            if (!activeKey && typeof __firebase_config === 'undefined') {
                 return {
                    type: "chat",
                    text: "⚠️ CONFIG ERROR: 'GEMINI_API_KEY' kosong.",
                };
            }

            const historyText = conversationHistory.map(msg => `${msg.role === 'user' ? 'Player' : 'Oracle'}: ${msg.text}`).join('\n');
            
            const systemPrompt = `
            Identity: Kamu adalah 'LifeQuest Oracle', AI pendamping perkembangan diri dengan gaya bahasa RPG/Sci-Fi yang seru, suportif, dan sedikit misterius.
            Mission: Analisis input Player (user).
            OUTPUT RULES (PENTING):
            Kamu harus merespons dalam format JSON saja.
            
            SCENARIO 1: OBROLAN BIASA (Chatting/Curhat/Sapaan)
            Jika input user BUKAN aktivitas spesifik (contoh: "Halo", "Siapa kamu?", "Saya sedih", "Motivasi dong"), gunakan tipe "chat".
            
            SCENARIO 2: AKTIVITAS KURANG JELAS (Ambigu)
            Jika input user aktivitas tapi samar (contoh: "mau belajar", "olahraga", "kerja"), gunakan tipe "question".
            
            SCENARIO 3: AKTIVITAS SPESIFIK (Jelas)
            Jika input user aktivitas jelas (contoh: "belajar matematika", "lari 5km", "bikin laporan"), gunakan tipe "quests".
            
            FORMAT JSON (Pilih satu yang sesuai):
            { "type": "chat", "text": "Halo Player! Siap menaklukkan hari ini?" }
            ATAU
            { "type": "question", "text": "Belajar apa spesifiknya? (Coding, Bahasa, dll)" }
            ATAU
            {
              "type": "quests",
              "quests": [
                { "diff": "Easy", "title": "Judul Quest", "desc": "Deskripsi...", "rewards": { "intellect": 2 } }
              ]
            }
            `;

            const fullPrompt = `${systemPrompt}\n\n[Riwayat Percakapan]\n${historyText}\n\nPlayer Input Terbaru: ${userMessage}\n\nOutput JSON Only:`;

            try {
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${activeKey}`;
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: fullPrompt }] }],
                        generationConfig: { responseMimeType: "application/json" }
                    })
                });

                if (!response.ok) {
                    throw new Error(`API Error: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                const textResult = data.candidates[0].content.parts[0].text;
                return JSON.parse(textResult);

            } catch (error) {
                console.error("AI Error:", error);
                return {
                    type: "chat",
                    text: `⚠️ SYSTEM ERROR: ${error.message}`
                };
            }
        }

        // --- DATA DEFS ---
        const STAT_DEFINITIONS = {
            intellect: { label: 'INT', fullLabel: 'Intellect', icon: 'brain', color: 'text-blue-400', bg: 'bg-blue-500/20', desc: 'Logika & Ilmu' },
            potential: { label: 'POT', fullLabel: 'Potential', icon: 'zap', color: 'text-yellow-400', bg: 'bg-yellow-500/20', desc: 'Bakat & Skill' },
            focus: { label: 'FOC', fullLabel: 'Focus', icon: 'target', color: 'text-emerald-400', bg: 'bg-emerald-500/20', desc: 'Konsentrasi' },
            discipline: { label: 'DIS', fullLabel: 'Discipline', icon: 'shield', color: 'text-slate-400', bg: 'bg-slate-500/20', desc: 'Rutinitas' },
            confidence: { label: 'CNF', fullLabel: 'Confidence', icon: 'star', color: 'text-orange-400', bg: 'bg-orange-500/20', desc: 'Sosial' },
            resilience: { label: 'RES', fullLabel: 'Resilience', icon: 'activity', color: 'text-red-400', bg: 'bg-red-500/20', desc: 'Mental' },
        };

        const TIERS = [
            { label: 'F', min: 0, color: 'text-slate-600' }, { label: 'E', min: 20, color: 'text-slate-400' },
            { label: 'D', min: 50, color: 'text-green-600' }, { label: 'C', min: 100, color: 'text-cyan-500' },
            { label: 'B', min: 200, color: 'text-blue-500' }, { label: 'A', min: 400, color: 'text-purple-500' },
            { label: 'S', min: 700, color: 'text-pink-500' }, { label: 'SS', min: 1200, color: 'text-yellow-400' },
            { label: 'EX', min: 5000, color: 'text-white drop-shadow-[0_0_5px_white]' },
        ];

        const INITIAL_STATS = { intellect: 0, potential: 0, focus: 0, discipline: 0, confidence: 0, resilience: 0 };

        // --- STATE ---
        let state = {
            user: null,
            view: 'dashboard',
            stats: { ...INITIAL_STATS },
            activeQuests: [],
            history: [],
            messages: [{ role: 'ai', text: 'System Online. Selamat datang, Player. Apa rencanamu hari ini?' }],
            proposedQuests: [],
            isTyping: false
        };

        // --- FIREBASE CONFIG ---
        let firebaseConfig;
        let appId = 'lifequest-default';

        try {
            if (typeof __firebase_config !== 'undefined') {
                firebaseConfig = JSON.parse(__firebase_config);
                if (typeof __app_id !== 'undefined') appId = __app_id;
            } else {
                throw new Error('Running externally');
            }
        } catch (e) {
            // KONFIGURASI MANUAL (Menggunakan Kunci Firebase ASLI)
            firebaseConfig = {
                apiKey: "AIzaSyAnxjcJOCqmC6T6kcRgKuYUC1iTkVLBdKs", // KUNCI LAMA (Untuk Database & Auth)
                authDomain: "gabriel1-1c7a6.firebaseapp.com",
                projectId: "gabriel1-1c7a6",
                storageBucket: "gabriel1-1c7a6.firebasestorage.app",
                messagingSenderId: "56792096758",
                appId: "1:56792096758:web:a16df7e3043a02025bb1d7",
                measurementId: "G-217YX90F4Q"
            };
        }

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- CORE LOGIC ---
        async function initAuth() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Auth Failed:", error);
                
                let tips = ["Cek koneksi internet.", "Refresh halaman."];
                if (error.code === 'auth/operation-not-allowed') {
                    tips = [
                        "Masuk ke Firebase Console > Authentication > Sign-in method.",
                        "Aktifkan 'Anonymous'."
                    ];
                } else if (error.message.includes('configuration-not-found')) {
                    // Specific handling for configuration-not-found
                    tips = [
                        "<strong>Config Error:</strong> API Key tidak cocok dengan Project ID.",
                        "Pastikan 'apiKey' di baris ~250 adalah kunci Firebase asli (AIzaSyAn...), BUKAN kunci Gemini.",
                        "Cek Firebase Console untuk API Key yang benar."
                    ];
                } else if (error.message.includes('identitytoolkit') || error.message.includes('blocked')) {
                    tips = [
                        "<strong>API Key Firebase Dibatasi.</strong>",
                        `Buka <a href="https://console.cloud.google.com/apis/credentials" target="_blank" class="text-blue-400 underline font-bold">Google Cloud Credentials</a>.`,
                        "Klik API Key (AIzaSyAn...).",
                        "Di API restrictions, pilih 'Don't restrict key' atau centang 'Identity Toolkit API'.",
                        "Save & Refresh."
                    ];
                }

                showFatalError(
                    "Gagal Masuk (Auth Failed)", 
                    error.message, 
                    tips
                );
            }
        }

        onAuthStateChanged(auth, (user) => {
            if (user) {
                state.user = user;
                setupRealtimeListener(user.uid);
            }
        });

        function setupRealtimeListener(userId) {
            const userRef = doc(db, 'artifacts', appId, 'users', userId, 'profile', 'data');
            onSnapshot(userRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    state.stats = data.stats || INITIAL_STATS;
                    state.activeQuests = data.activeQuests || [];
                    state.history = data.history || [];
                } else {
                    setDoc(userRef, { stats: INITIAL_STATS, activeQuests: [], history: [], createdAt: serverTimestamp() });
                }
                updateUI();
                updateBadges();
            }, (error) => {
                showFatalError("Database Error", error.message, [
                    "Cek Firestore Rules di Console.",
                    "Pastikan 'read, write' diizinkan untuk 'request.auth != null'."
                ]);
            });
        }

        // --- RENDER HELPERS ---
        function renderPolygon() {
            const maxVal = 200;
            const points = Object.keys(INITIAL_STATS).map((key, i) => {
                const val = Math.min(state.stats[key], maxVal);
                const angle = (Math.PI * 2 * i) / 6;
                const x = 50 + (val / maxVal) * 50 * Math.cos(angle - Math.PI / 2);
                const y = 50 + (val / maxVal) * 50 * Math.sin(angle - Math.PI / 2);
                return `${x},${y}`;
            }).join(' ');

            return `
            <div class="relative w-56 h-56 mx-auto my-6">
                <svg viewBox="0 0 100 100" class="w-full h-full drop-shadow-[0_0_15px_rgba(56,189,248,0.2)]">
                    <polygon points="50,0 93.3,25 93.3,75 50,100 6.7,75 6.7,25" fill="#1e293b" stroke="#334155" stroke-width="0.5" />
                    <polygon points="50,25 71.6,37.5 71.6,62.5 50,75 28.3,62.5 28.3,37.5" fill="none" stroke="#334155" stroke-width="0.5" />
                    <polygon points="${points}" fill="rgba(56, 189, 248, 0.4)" stroke="#38bdf8" stroke-width="2" />
                </svg>
                <div class="radar-label top-0 left-1/2 -translate-y-5 text-blue-400">INT</div>
                <div class="radar-label top-[25%] right-0 translate-x-3 text-yellow-400">POT</div>
                <div class="radar-label bottom-[25%] right-0 translate-x-3 text-emerald-400">FOC</div>
                <div class="radar-label bottom-0 left-1/2 translate-y-5 text-slate-400">DIS</div>
                <div class="radar-label bottom-[25%] left-0 -translate-x-3 text-orange-400">CNF</div>
                <div class="radar-label top-[25%] left-0 -translate-x-3 text-red-400">RES</div>
            </div>`;
        }

        function renderStatRows() {
            return Object.keys(INITIAL_STATS).map(key => {
                const def = STAT_DEFINITIONS[key];
                const val = state.stats[key];
                const tier = [...TIERS].reverse().find(t => val >= t.min) || TIERS[0];
                return `
                <div class="flex items-center justify-between bg-slate-900/80 p-3 rounded-xl border border-slate-800 mb-2">
                    <div class="flex items-center gap-3">
                        <div class="p-2.5 rounded-lg ${def.bg} ${def.color}">
                            <i data-lucide="${def.icon}" class="w-5 h-5"></i>
                        </div>
                        <div>
                            <div class="text-[10px] text-slate-500 font-bold uppercase tracking-widest mb-0.5">${def.fullLabel}</div>
                            <div class="text-xs text-slate-300">${def.desc}</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-lg font-black ${def.color} tabular-nums">${val}</div>
                        <div class="text-[10px] ${tier.color} font-bold uppercase tracking-wider border border-slate-700 px-1.5 py-0.5 rounded bg-slate-950">Rank ${tier.label}</div>
                    </div>
                </div>`;
            }).join('');
        }

        function renderDashboard() {
            return `
            <div class="animate-fade-in pb-8">
                <div class="text-center space-y-1 mb-8 mt-2">
                    <h2 class="text-3xl font-black text-white tracking-widest uppercase glow-text italic">STATUS</h2>
                    <p class="text-emerald-500/80 text-xs font-mono uppercase tracking-widest">Player Profile</p>
                </div>
                ${renderPolygon()}
                <div class="grid gap-2 mt-8">
                    ${renderStatRows()}
                </div>
            </div>`;
        }

        function renderChat() {
            const messagesHtml = state.messages.map(msg => {
                let styles = '';
                if (msg.role === 'user') styles = 'bg-blue-600/90 text-white rounded-br-none ml-auto border border-blue-500/50 shadow-lg shadow-blue-900/20';
                else if (msg.role === 'system') styles = 'bg-slate-900 text-yellow-400 border border-yellow-500/30 text-xs font-mono text-center w-full shadow-lg';
                else styles = 'bg-slate-800/90 text-slate-200 border border-slate-700 rounded-bl-none mr-auto shadow-lg';
                
                return `
                <div class="flex mb-4 w-full">
                    <div class="max-w-[85%] p-3.5 rounded-2xl text-sm leading-relaxed ${styles}">
                        ${msg.text}
                    </div>
                </div>`;
            }).join('');

            const typingHtml = state.isTyping ? `
                <div class="flex justify-start mb-4">
                    <div class="bg-slate-800 p-4 rounded-2xl rounded-bl-none border border-slate-700 flex gap-2 items-center">
                        <span class="w-1.5 h-1.5 bg-emerald-500 rounded-full animate-bounce-dot" style="animation-delay: 0ms"></span>
                        <span class="w-1.5 h-1.5 bg-emerald-500 rounded-full animate-bounce-dot" style="animation-delay: 150ms"></span>
                        <span class="w-1.5 h-1.5 bg-emerald-500 rounded-full animate-bounce-dot" style="animation-delay: 300ms"></span>
                    </div>
                </div>` : '';

            const proposalsHtml = state.proposedQuests.length > 0 ? `
                <div class="space-y-3 mt-4 animate-fade-in pb-4">
                    <div class="flex items-center gap-2 justify-center mb-2">
                        <div class="h-px bg-slate-800 flex-1"></div>
                        <p class="text-[10px] text-emerald-500 uppercase font-bold tracking-widest">Mission Select</p>
                        <div class="h-px bg-slate-800 flex-1"></div>
                    </div>
                    ${state.proposedQuests.map((q, i) => {
                        const diffColor = q.diff === 'Easy' ? 'text-green-400 bg-green-950/50 border-green-800' : q.diff === 'Normal' ? 'text-blue-400 bg-blue-950/50 border-blue-800' : 'text-red-400 bg-red-950/50 border-red-800';
                        return `
                        <div class="bg-slate-900/80 backdrop-blur border border-slate-800 p-4 rounded-xl hover:border-emerald-500/50 transition-all relative overflow-hidden group">
                            <div class="flex justify-between items-start mb-2">
                                <h4 class="font-bold text-slate-100">${q.title}</h4>
                                <span class="text-[10px] font-bold uppercase px-2 py-1 rounded border ${diffColor}">${q.diff}</span>
                            </div>
                            <p class="text-xs text-slate-400 mb-4 leading-relaxed">${q.desc}</p>
                            <div class="flex flex-wrap gap-2 mb-4">
                                ${Object.entries(q.rewards).map(([k, v]) => `<span class="text-[10px] bg-slate-950 px-2 py-1 rounded text-slate-300 border border-slate-800 font-mono">+${v} ${STAT_DEFINITIONS[k].label}</span>`).join('')}
                            </div>
                            <button onclick="acceptQuest(${i})" class="w-full py-2.5 bg-emerald-600/10 hover:bg-emerald-600 text-emerald-500 hover:text-white border border-emerald-600/50 rounded-lg font-bold text-sm transition-all flex items-center justify-center gap-2 group-hover:shadow-[0_0_15px_rgba(16,185,129,0.3)]">
                                <i data-lucide="check-circle" class="w-4 h-4"></i> Terima Quest
                            </button>
                        </div>`
                    }).join('')}
                </div>` : '';

            // Layout Chat yang diperbaiki menggunakan Flexbox penuh
            return `
            <div class="flex flex-col h-full">
                <div id="chat-container" class="flex-1 overflow-y-auto px-1 py-2 space-y-2">
                    ${messagesHtml}
                    ${typingHtml}
                    ${proposalsHtml}
                    <div class="h-4"></div> <!-- Spacer bawah -->
                </div>
                <form onsubmit="handleSendMessage(event)" class="mt-2 flex gap-2 pt-3 border-t border-slate-800/50 shrink-0 bg-slate-950 sticky bottom-0 z-10">
                    <input id="chat-input" type="text" placeholder="Ketik aktivitas atau obrolan..." 
                        class="flex-1 bg-slate-900 border border-slate-800 rounded-xl px-4 py-3.5 text-sm text-white focus:outline-none focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500 placeholder:text-slate-600 transition-all" 
                        ${state.proposedQuests.length > 0 ? 'disabled' : ''} autocomplete="off">
                    <button type="submit" ${state.proposedQuests.length > 0 ? 'disabled' : ''} 
                        class="bg-emerald-600 text-white p-3.5 rounded-xl disabled:opacity-50 hover:bg-emerald-500 transition-colors shadow-lg shadow-emerald-900/20">
                        <i data-lucide="send" class="w-5 h-5 fill-current"></i>
                    </button>
                </form>
            </div>`;
        }

        function renderQuests() {
            if (state.activeQuests.length === 0) {
                return `
                <div class="space-y-4 h-full flex flex-col justify-center">
                    <div class="text-center py-12 px-6 bg-slate-900/50 rounded-2xl border border-slate-800 border-dashed">
                        <div class="w-16 h-16 bg-slate-800 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i data-lucide="target" class="text-slate-600 w-8 h-8"></i>
                        </div>
                        <h3 class="text-white font-bold mb-2">Tidak Ada Quest Aktif</h3>
                        <p class="text-slate-500 text-sm mb-6">Oracle sedang menunggu laporan aktivitasmu.</p>
                        <button onclick="router('chat')" class="px-6 py-2 bg-emerald-600 text-white text-sm font-bold rounded-full hover:bg-emerald-500 transition-all shadow-lg shadow-emerald-900/20">
                            Minta Quest Baru
                        </button>
                    </div>
                </div>`;
            }

            return `
            <div class="space-y-6 pb-20">
                <div class="flex items-center gap-2 mb-2">
                    <div class="p-2 bg-emerald-500/10 rounded-lg">
                        <i data-lucide="activity" class="text-emerald-500 w-5 h-5"></i>
                    </div>
                    <h2 class="text-xl font-black text-white tracking-wide uppercase">Active Quests</h2>
                </div>
                ${state.activeQuests.map(q => {
                    const diffColor = q.diff === 'Easy' ? 'text-green-400 bg-green-950 border-green-900' : q.diff === 'Normal' ? 'text-blue-400 bg-blue-950 border-blue-900' : 'text-red-400 bg-red-950 border-red-900';
                    return `
                    <div class="bg-slate-900 border border-slate-800 p-5 rounded-2xl shadow-xl relative overflow-hidden animate-fade-in group">
                        <div class="absolute top-0 left-0 w-1 h-full bg-emerald-500"></div>
                        <div class="flex justify-between items-start mb-3 pl-3">
                            <h3 class="font-bold text-lg text-white leading-tight">${q.title}</h3>
                            <span class="text-[10px] px-2 py-1 rounded border font-bold uppercase ${diffColor}">${q.diff}</span>
                        </div>
                        <p class="text-sm text-slate-400 mb-5 pl-3 leading-relaxed">${q.desc}</p>
                        <div class="flex gap-2 mb-6 pl-3">
                            ${Object.entries(q.rewards).map(([k, v]) => `<span class="text-[10px] text-emerald-400 font-bold bg-emerald-950/30 px-2 py-1 rounded border border-emerald-900/50">+${v} ${STAT_DEFINITIONS[k].label}</span>`).join('')}
                        </div>
                        <div class="flex gap-3 pl-3">
                            <button onclick="completeQuest('${q.id}')" class="flex-1 bg-emerald-600 hover:bg-emerald-500 text-white py-3 rounded-xl text-sm font-bold flex items-center justify-center gap-2 shadow-lg shadow-emerald-900/20 transition-all active:scale-95">
                                <i data-lucide="check-circle" class="w-4 h-4"></i> Complete
                            </button>
                            <button onclick="abandonQuest('${q.id}')" class="px-4 bg-slate-800 hover:bg-red-900/20 hover:text-red-400 hover:border-red-900/50 border border-slate-700 text-slate-400 rounded-xl transition-all" title="Batalkan">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>`
                }).join('')}
            </div>`;
        }

        // --- GLOBAL FUNCS ---
        window.handleSendMessage = async (e) => {
            e.preventDefault();
            const inputEl = document.getElementById('chat-input');
            const val = inputEl.value.trim();
            if(!val) return;
            
            inputEl.value = '';
            state.proposedQuests = [];
            state.messages.push({ role: 'user', text: val });
            state.isTyping = true;
            updateUI();
            
            // Auto scroll
            setTimeout(() => {
                const c = document.getElementById('chat-container');
                if(c) c.scrollTop = c.scrollHeight;
            }, 50);

            try {
                // Konteks hanya 3 pesan terakhir agar hemat token dan relevan
                const contextHistory = state.messages.slice(-3); 
                const aiResponse = await callGeminiAI(val, contextHistory);

                state.isTyping = false;
                if (aiResponse.type === 'question') {
                    state.messages.push({ role: 'ai', text: aiResponse.text || "Mohon detail lebih lanjut." });
                } else if (aiResponse.type === 'quests') {
                    state.proposedQuests = aiResponse.quests;
                    state.messages.push({ role: 'ai', text: 'Analisis selesai. Pilih Quest:' });
                } else if (aiResponse.type === 'chat') {
                    state.messages.push({ role: 'ai', text: aiResponse.text || "Siap!" });
                } else {
                    state.messages.push({ role: 'ai', text: 'Maaf, data tidak terbaca.' });
                }
            } catch (err) {
                console.error(err);
                state.isTyping = false;
                state.messages.push({ role: 'ai', text: 'Koneksi Neural terputus. Menggunakan protokol darurat.' });
            }
            updateUI();
            setTimeout(() => {
                const c = document.getElementById('chat-container');
                if(c) c.scrollTop = c.scrollHeight;
            }, 50);
        };

        window.acceptQuest = async (index) => {
            if (!state.user) return;
            const questData = state.proposedQuests[index];
            const newQuest = { ...questData, id: Date.now().toString(), status: 'active', startedAt: new Date().toISOString() };
            state.activeQuests.push(newQuest);
            state.proposedQuests = [];
            state.messages.push({ role: 'system', text: `Misi "${questData.title}" diterima.` });
            state.view = 'quests';
            updateUI();
            updateBadges();
            await updateDoc(doc(db, 'artifacts', appId, 'users', state.user.uid, 'profile', 'data'), { activeQuests: arrayUnion(newQuest) });
        };

        window.completeQuest = async (questId) => {
            if (!state.user) return;
            const quest = state.activeQuests.find(q => q.id === questId);
            if (!quest) return;
            const updatedStats = { ...state.stats };
            Object.entries(quest.rewards).forEach(([key, val]) => { updatedStats[key] = (updatedStats[key] || 0) + val; });
            const completedQuest = { ...quest, status: 'completed', completedAt: new Date().toISOString() };
            state.stats = updatedStats;
            state.activeQuests = state.activeQuests.filter(q => q.id !== questId);
            state.history.unshift(completedQuest);
            updateUI();
            updateBadges();
            await updateDoc(doc(db, 'artifacts', appId, 'users', state.user.uid, 'profile', 'data'), { activeQuests: arrayRemove(quest), history: arrayUnion(completedQuest), stats: updatedStats });
        };

        window.abandonQuest = async (questId) => {
            if (!state.user) return;
            const quest = state.activeQuests.find(q => q.id === questId);
            if (!quest) return;
            state.activeQuests = state.activeQuests.filter(q => q.id !== questId);
            updateUI();
            updateBadges();
            await updateDoc(doc(db, 'artifacts', appId, 'users', state.user.uid, 'profile', 'data'), { activeQuests: arrayRemove(quest) });
        };

        window.router = (v) => { 
            state.view = v; 
            updateUI(); 
        };

        function updateBadges() {
            const badge = document.getElementById('quest-badge');
            if(badge) badge.classList.toggle('hidden', state.activeQuests.length === 0);
            if(badge) badge.innerText = state.activeQuests.length;

            const notif = document.getElementById('chat-notification');
            const dot = document.getElementById('chat-notification-dot');
            const hasNotif = state.activeQuests.length === 0 && state.view !== 'chat';
            if(notif) notif.classList.toggle('hidden', !hasNotif);
            if(dot) dot.classList.toggle('hidden', !hasNotif);

            ['dashboard', 'chat', 'quests'].forEach(v => {
                const btn = document.getElementById(`nav-${v}`);
                if(btn) {
                    const icon = btn.querySelector('i') || btn.querySelector('svg');
                    
                    if(state.view === v) {
                        btn.classList.add('text-emerald-400');
                        btn.classList.remove('text-slate-500');
                        if (icon) icon.classList.add('stroke-2');
                    } else {
                        btn.classList.remove('text-emerald-400');
                        btn.classList.add('text-slate-500');
                        if (icon) icon.classList.remove('stroke-2');
                    }
                }
            });
        }

        function updateUI() {
            const container = document.getElementById('app-container');
            if(!container) return;
            if(state.view === 'dashboard') container.innerHTML = renderDashboard();
            else if(state.view === 'chat') container.innerHTML = renderChat();
            else if(state.view === 'quests') container.innerHTML = renderQuests();
            lucide.createIcons();
            
            // Auto focus chat
            if(state.view === 'chat' && !state.isTyping && state.proposedQuests.length === 0) {
                 const input = document.getElementById('chat-input');
                 if(input) input.focus();
            }
        }

        window.onload = initAuth;
    </script>
</body>
</html>
